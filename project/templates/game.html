{%extends "layout.html"%}
{%block head%}
    <title>Game/Chat</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet", href="{{url_for("static", filename="css/desktop.css")}}", type="text/css"/>
    <!-- <link rel="stylesheet", href="{{url_for("static", filename="css/chat.css")}}", type="text/css"/> -->

    <!-- controller/game -->
    <script  type="text/javascript" src="{{ url_for('static', filename='bower_components/phaser/dist/phaser.min.js') }}"></script>
    <script type = "text/javascript" src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
    <script type="text/javascript" src="{{url_for("static", filename="bower_components/jquery/dist/jquery.min.js")}}"></script>

	<!-- react-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
	<script type = "text/javascript">
		var lobbycode = "{{code|safe}}"
		var socket = io.connect('http://' + document.domain + ':' + location.port);
	
		socket.on('connect', function() {
			socket.emit('create', {'code': lobbycode});
		});
	</script>
   <!-- chat-->
   
{%endblock%}
{%block body%}

    <div style="padding:10px;margin-top:20px;"></div>
    
    <div class="flex-container">
       
           <!-- for game-->
        <div id="game" style="flex-grow: 4">
            <!-- <script type="text/javascript" src="{{url_for('static', filename='scripts/js/testGame.js')}}"></script> -->
        </div>

        <!-- for react chat-->
        <div id="Chat" style="flex-grow: 1">
			<script type="text/babel">
				const Message = ({chat, user}) => (
					<div>
						<p className="um">{chat.username}</p>
						<li className={`chat ${user === chat.username ? "right" : "left"}`}>
							{user !== chat.username
							}
							{chat.content}
						</li>
					</div>
				);

				class Chatroom extends React.Component {
					constructor(props) {
						super(props);
						this.state = {chats:[]};
						this.submitMessage = this.submitMessage.bind(this);
						this._handleNewMessage = this._handleNewMessage.bind(this);
					}
					getInitialState() {
						return {chats:[]};
					}
					_handleNewMessage(m, sender) {
						this.setState({
							chats: this.state.chats.concat([{
								username: sender,
								content: <p>{m}</p>
							}])
						}, () => {
							ReactDOM.findDOMNode(this.refs.msg).value = "";
						});
					}
					componentDidMount() {
						socket.on('new message', this._handleNewMessage);
						this.scrollToBot();
					}

					componentDidUpdate() {
						this.scrollToBot();
					}

					scrollToBot() {
						ReactDOM.findDOMNode(this.refs.chats).scrollTop = ReactDOM.findDOMNode(this.refs.chats).scrollHeight;
					}

					submitMessage(e) {
						e.preventDefault();
						socket.emit('new message', {"username":username, "room":lobbycode, "message":ReactDOM.findDOMNode(this.refs.msg).value});
						this.setState({
							chats: this.state.chats.concat([{
								username: "username",
								content: <p>{ReactDOM.findDOMNode(this.refs.msg).value}</p>
							}])
						}, () => {
							ReactDOM.findDOMNode(this.refs.msg).value = "";
						});
					}
					
					
					
					render() {
						const username = "username";
						const { chats } = this.state;

						return (
							<div className="chatroom">
								<h3>Squircle</h3>
								<ul className="chats" ref="chats">
									{
										chats.map((chat) => 
											<Message chat={chat} user={username} />
										)
									}
								</ul>
								<form className="input" onSubmit={(e) => this.submitMessage(e)}>
									<input type="text" ref="msg" />
									<input type="submit" value="Submit" />
								</form>
							</div>
						);
					}
				}
					
				ReactDOM.render(
					<Chatroom />,
					document.getElementById('Chat')
				);
			</script>
        </div>
    </div>

    

{%endblock%}