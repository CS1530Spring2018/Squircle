{%extends "layout.html"%}
{%block head%}
    <title>Game/Chat</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet", href="{{url_for("static", filename="css/desktop.css")}}", type="text/css"/>
    <!-- <link rel="stylesheet", href="{{url_for("static", filename="css/chat.css")}}", type="text/css"/> -->

    <!-- controller/game -->
    <script  type="text/javascript" src="{{ url_for('static', filename='bower_components/phaser/dist/phaser.min.js') }}"></script>
    <script type = "text/javascript" src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
    <script type="text/javascript" src="{{url_for("static", filename="bower_components/jquery/dist/jquery.min.js")}}"></script>

	<!-- react-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
	<script type = "text/javascript">
		var lobbycode = "{{code|safe}}"
		var socket = io.connect('http://' + document.domain + ':' + location.port);
	
		socket.on('connect', function() {
			socket.emit('create', {'code': lobbycode});
		});
	</script>
   <!-- chat-->
   
{%endblock%}
{%block body%}

    <div style="padding:10px;margin-top:20px;"></div>
    
    <div class="flex-container">
       
           <!-- for game-->
        <div id="game" style="flex-grow: 4">
            <!-- <script type="text/javascript" src="{{url_for('static', filename='scripts/js/testGame.js')}}"></script> -->
        </div>

        <!-- for react chat-->
        <div id="Chat" style="flex-grow: 1">
			<script type="text/babel">
				const Message = ({chat, user}) => (
					<li className={`chat ${user === chat.username ? "right" : "left"}`}>
						{user !== chat.username
							&& <img src={chat.img} alt={`${chat.username}'s profile pic`} />
						}
						{chat.content}
					</li>
				);

				class Chatroom extends React.Component {
					constructor(props) {
						super(props);

						this.state = {
							chats: [//{
								// username: "username",
								// content: <p>usernameusernames</p>,
								// img: "http://i.imgur.com/Tj5DGiO.jpg", // 
							// }, {
								// username: "user1",
								// content: <p>user1</p>,
								// img: "http://i.imgur.com/Tj5DGiO.jpg",
							// }, {
								// username: "user2",
								// content: <p>user2</p>,
								// img: "http://i.imgur.com/Tj5DGiO.jpg",
							// }, {
								// username: "user3",
								// content: <p>user3</p>,
								// img: "http://i.imgur.com/ARbQZix.jpg",
							//}
							]
						};

						this.submitMessage = this.submitMessage.bind(this);
					}

					componentDidMount() {
						socket.on('new message', function(m, sender) {
							this.setState({
								chats: this.state.chats.concat([{
									username: sender,
									content: <p>m</p>,
									//img: "http://i.imgur.com/Tj5DGiO.jpg",
								}])
							}, () => {
								ReactDOM.findDOMNode(this.refs.msg).value = "";
							});
						});
						this.scrollToBot();
					}

					componentDidUpdate() {
						this.scrollToBot();
					}

					scrollToBot() {
						ReactDOM.findDOMNode(this.refs.chats).scrollTop = ReactDOM.findDOMNode(this.refs.chats).scrollHeight;
					}

					submitMessage(e) {
						e.preventDefault();
						socket.emit('new message', {"username":username, "room":lobbycode, "message":ReactDOM.findDOMNode(this.refs.msg).value});
						this.setState({
							chats: this.state.chats.concat([{
								username: "username",
								content: <p>{ReactDOM.findDOMNode(this.refs.msg).value}</p>,
								//img: "http://i.imgur.com/Tj5DGiO.jpg",
							}])
						}, () => {
							ReactDOM.findDOMNode(this.refs.msg).value = "";
						});
					}
					
					
					
					render() {
						const username = "username";
						const { chats } = this.state;

						return (
							<div className="chatroom">
								<h3>Squircle</h3>
								<ul className="chats" ref="chats">
									{
										chats.map((chat) => 
											<Message chat={chat} user={username} />
										)
									}
								</ul>
							</div>
						);
					}
				}
					
				ReactDOM.render(
					<Chatroom />,
					document.getElementById('Chat')
				);
			</script>
        </div>
    </div>

    

{%endblock%}